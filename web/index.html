<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMH Travel</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>


<body class="bg-gray-100">
    <div id="loading-overlay"></div>
    <div class="container mx-auto py-8">
        <h1 class="text-2xl font-bold mb-4">SMH Travel</h1>

        {% if files %}
        <!-- Global Inputs -->
        <div class="mb-6 bg-white p-4 shadow rounded">
            <h2 class="text-lg font-bold mb-2">For all tickets below</h2>
            <div class="flex space-x-4 mb-4">
                <input id="global_base_price" type="number" placeholder="Base Price" class="border p-2 rounded">
                <input id="global_airport_tax" type="number" placeholder="Airport Tax" class="border p-2 rounded">
                <input id="global_service_tax" type="number" placeholder="Service Tax" class="border p-2 rounded">
                <select id="global_template" class="border p-2 rounded">
                    {% for template in templates %}
                    <option value="{{ template }}">{{ template }}</option>
                    {% endfor %}
                </select>
                <input id="global_total_price" type="number" placeholder="Total price" class="border p-2 rounded">
            </div>
        </div>

        <!-- File List -->
        <ul>
            {% for file in files %}
            <li class="mb-4 bg-white p-4 shadow rounded">
                <div class="mb-2">
                    <strong>
                        <a href="/preview-file/?file={{ file }}" target="_blank" class="text-blue-500 hover:underline">
                            {{ file.0 }}
                        </a>
                    </strong>
                </div>
                <div class="flex space-x-4">
                    <input type="number" id="{{file.0}}-Base-Price" placeholder="Base Price" class="border p-2 rounded file-base-price">
                    <input type="number" id="{{file.0}}-Airport-Tax" placeholder="Airport Tax" class="border p-2 rounded file-airport-tax">
                    <input type="number" id="{{file.0}}-Service-Tax" placeholder="Service Tax" class="border p-2 rounded file-service-tax">
                    <select id="{{file.0}}-file-template" class="border p-2 rounded file-template">
                        {% for template in templates %}
                        <option value="{{ template }}">{{ template }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" id="{{file.0}}-Total-Price" placeholder="Total Price" class="border p-2 rounded file-total-price">
                    <input type="text" hidden class="border p-2 rounded file-old-name" value="{{ file.0 }}">
                    {% if file.1 %}
                    <input type="text" hidden class="border p-2 rounded file-new-name" value="{{ file.1 }}">
                    <a href="/output-preview/?file={{ file.1 }}"><button
                        class="bg-green-500 text-white px-4 py-2 rounded file-new-download">Download new</button></a>
                    <button class="bg-red-500 text-white px-4 py-2 rounded file-new-discard">Discard</button>
                    {% else %}
                    <button class="bg-blue-500 text-white px-4 py-2 rounded file-new-generate">Generate</button>
                    {% endif %}
                    <button class="bg-red-500 text-white px-4 py-2 rounded file-old-clear">Remove</button>
                </div>
            </li>
            {% endfor %}
        </ul>

        <!-- Actions -->
        <div class="mt-6 flex space-x-4">
            <button id="clear_all" class="bg-red-500 text-white px-4 py-2 rounded">Remove All Files</button>
            <button id="discard_all" class="bg-red-500 text-white px-4 py-2 rounded">Discard all</button>
            <button id="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Generate all</button>
            <button id="download_all" class="bg-green-500 text-white px-4 py-2 rounded">Download all</button>
        </div>
        {% else %}
        <!-- Upload Form -->
        <div class="bg-white p-6 shadow rounded">
            <form id="upload_form" enctype="multipart/form-data">
                <label class="block mb-2 font-bold">Upload PDF Files</label>
                <input type="file" name="files" id="file_input" multiple class="block mb-4">
                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Upload</button>
            </form>
        </div>
        {% endif %}
    </div>

    <script>
        // Function to listen to all inputs and save their values in localStorage
function saveInputsToLocalStorage() {
  const inputs = document.querySelectorAll('input, select, textarea');
  inputs.forEach((input) => {
    input.addEventListener('input', () => {
      const inputData = {};
      inputs.forEach((el) => {
        inputData[el.name || el.id] = el.value;
      });
      localStorage.setItem('formData', JSON.stringify(inputData));
    });
  });
}

// Function to read from localStorage and set input values in the document
function loadInputsFromLocalStorage() {
  const formData = JSON.parse(localStorage.getItem('formData'));
  if (!formData) return;

  const inputs = document.querySelectorAll('input, select, textarea');
  inputs.forEach((input) => {
    const key = input.name || input.id;
    if (formData[key] !== undefined) {
      input.value = formData[key];
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  loadInputsFromLocalStorage();
  saveInputsToLocalStorage();
});

        const setLoadingState = (isLoading) => {
            // Select all inputs and buttons
            const inputs = document.querySelectorAll('input, button, select, textarea');

            // Disable or enable them based on the loading state
            inputs.forEach((input) => {
                input.disabled = isLoading;
            });

            // Optionally, show or hide a loading indicator
            let loadingOverlay = document.getElementById('loading-overlay');
            if (isLoading) {
                if (!loadingOverlay) {
                    // Create a loading overlay if it doesn't exist
                    loadingOverlay = document.createElement('div');
                    loadingOverlay.id = 'loading-overlay';
                    loadingOverlay.innerHTML = `
        <div class="fixed inset-0 bg-gray-700 bg-opacity-50 flex items-center justify-center z-50">
          <div class="text-white text-lg font-bold">Loading...</div>
        </div>
      `;
                    document.body.appendChild(loadingOverlay);
                }
                loadingOverlay.style.display = 'flex'; // Show overlay
            } else if (loadingOverlay) {
                loadingOverlay.style.display = 'none'; // Hide overlay
            }
        }

        const showLoading = () => setLoadingState(true);
        const hideLoading = () => setLoadingState(false);

        // Handle File Upload
        const uploadForm = document.getElementById('upload_form');
        if (uploadForm) {
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData();
                const files = document.getElementById('file_input').files;
                for (let file of files) {
                    formData.append('files', file);
                }
                try {
                 showLoading()
                    await axios.post('/upload-files/', formData, { headers: { 'Content-Type': 'multipart/form-data' } });
                    window.location.reload();
                } catch (err) {
                    console.error(err);
                    hideLoading()
                } 
            });
        }

        // Handle Clear All Files
        const clearAllButton = document.getElementById('clear_all');
        if (clearAllButton) {
            clearAllButton.addEventListener('click', async () => {
                try {
                 showLoading()

                    await axios.delete('/upload-clear/');
                    await axios.delete('/output-discard/');
                    window.location.reload();
                } catch (err) {
                    console.error(err);
                    hideLoading()
                }
            });
        }
        const discard_all = document.getElementById('discard_all');
        if (discard_all) {
            discard_all.addEventListener('click', async () => {
                try {
                 showLoading()
                    await axios.delete('/output-discard/');
                    window.location.reload();
                } catch (err) {
                    console.error(err);
                    hideLoading()
                }
            });
        }
        const download_all = document.getElementById('download_all');
        if (download_all) {
            download_all.addEventListener('click', async () => {
                window.open('/output-preview/', '_blank');
            });
        }

        // Handle Global Input Changes
        const globalBasePrice = document.getElementById('global_base_price');
        const globalAirportTax = document.getElementById('global_airport_tax');
        const globalServiceTax = document.getElementById('global_service_tax');
        const globalTemplate = document.getElementById('global_template');
        const globalTotalPrice = document.getElementById('global_total_price');

        const updateFileInputs = () => {
            const fileBasePrices = document.querySelectorAll('.file-base-price');
            const fileAirportTaxes = document.querySelectorAll('.file-airport-tax');
            const fileServiceTaxes = document.querySelectorAll('.file-service-tax');
            const fileTemplates = document.querySelectorAll('.file-template');
            const fileTotalPrice = document.querySelectorAll('.file-total-price');

            fileBasePrices.forEach(input => input.value = globalBasePrice.value || input.value);
            fileAirportTaxes.forEach(input => input.value = globalAirportTax.value || input.value);
            fileServiceTaxes.forEach(input => input.value = globalServiceTax.value || input.value);
            fileTemplates.forEach(select => select.value = globalTemplate.value || select.value);
            fileTotalPrice.forEach(input => input.value = globalTotalPrice.value || input.value);
        };

        [globalBasePrice, globalAirportTax, globalServiceTax, globalTemplate, globalTotalPrice].forEach(input => {
            input.addEventListener('input', updateFileInputs);
        });

        // Handle Submit
        const submitButton = document.getElementById('submit');
        if (submitButton) {
            const files = document.querySelectorAll('li');
            Array.from(files).forEach((file) => {
                file.querySelector('.file-old-clear')?.addEventListener('click', async () => {
                    try {
                 showLoading()

                        await axios.delete('/upload-clear/?file=' + file.querySelector('.file-old-name').value);
                        window.location.reload();
                    } catch (err) {
                        console.error(err);
                        hideLoading()
                    } 
                });
                file.querySelector('.file-new-discard')?.addEventListener('click', async () => {
                    try {
                 showLoading()

                        await axios.delete('/output-discard/?file=' + file.querySelector('.file-new-name').value);
                        window.location.reload();
                    } catch (err) {
                        console.error(err);
                        hideLoading()
                    } 
                });
                file.querySelector('.file-new-generate')?.addEventListener('click', async () => {
                    try {
                 showLoading()

                        await axios.post(`/upload-process/?file=` + file.querySelector('.file-old-name').value, {
                            base_price: file.querySelector('.file-base-price').value,
                            airport_tax: file.querySelector('.file-airport-tax').value,
                            service_tax: file.querySelector('.file-service-tax').value,
                            template: file.querySelector('.file-template').value,
                            total_price: file.querySelector('.file-total-price').value,
                        });
                        window.location.reload();
                    } catch (err) {
                        console.error(err);
                        hideLoading()
                    }
                });
            })

            submitButton.addEventListener('click', async () => {
                const files = document.querySelectorAll('li');

                const data = Array.from(files).map((file) => ({
                    name: file.querySelector('a').innerText,
                    base_price: file.querySelector('.file-base-price').value,
                    airport_tax: file.querySelector('.file-airport-tax').value,
                    service_tax: file.querySelector('.file-service-tax').value,
                    template: file.querySelector('.file-template').value,
                    total_price: file.querySelector('.file-total-price').value,
                }));


                try {
                    showLoading()
                    await axios.post('/upload-process/', data);
                    window.location.reload();
                } catch (err) {
                    console.error(err);
                    hideLoading()
                }
            });
        }
    </script>
</body>

</html>